# üöÄ Node.js ËÅäÂ§©ÂêéÁ´Ø ÈÉ®ÁΩ≤ÊåáÂçó

## üìã ÁõÆÂΩï

- [Âø´ÈÄüÈÉ®ÁΩ≤](#Âø´ÈÄüÈÉ®ÁΩ≤)
- [ÁéØÂ¢ÉË¶ÅÊ±Ç](#ÁéØÂ¢ÉË¶ÅÊ±Ç)
- [Áîü‰∫ßÁéØÂ¢ÉÈÉ®ÁΩ≤](#Áîü‰∫ßÁéØÂ¢ÉÈÉ®ÁΩ≤)
- [DockerÂÆπÂô®ÈÉ®ÁΩ≤](#dockerÂÆπÂô®ÈÉ®ÁΩ≤)
- [ÊÄßËÉΩ‰ºòÂåñ](#ÊÄßËÉΩ‰ºòÂåñ)
- [ÁõëÊéßÂíåÊó•Âøó](#ÁõëÊéßÂíåÊó•Âøó)
- [Êï∞ÊçÆÂ∫ìËøÅÁßª](#Êï∞ÊçÆÂ∫ìËøÅÁßª)
- [SSLËØÅ‰π¶ÈÖçÁΩÆ](#sslËØÅ‰π¶ÈÖçÁΩÆ)
- [Ë¥üËΩΩÂùáË°°ÈÖçÁΩÆ](#Ë¥üËΩΩÂùáË°°ÈÖçÁΩÆ)
- [Â§á‰ªΩÂíåÊÅ¢Â§ç](#Â§á‰ªΩÂíåÊÅ¢Â§ç)
- [ÊïÖÈöúÊéíÈô§](#ÊïÖÈöúÊéíÈô§)

---

## üöÄ Âø´ÈÄüÈÉ®ÁΩ≤

### 1. ÁéØÂ¢ÉÂáÜÂ§á

```bash
# Ê£ÄÊü•Node.jsÁâàÊú¨
node --version  # ÈúÄË¶Å 18+
npm --version   # ÈúÄË¶Å 9+

# Ê£ÄÊü•MySQLÁâàÊú¨
mysql --version  # ÈúÄË¶Å 8.0+
```

### 2. È°πÁõÆÈÉ®ÁΩ≤

```bash
# ÂÖãÈöÜÈ°πÁõÆ
git clone https://github.com/your-repo/nodejs-chat-backend.git
cd nodejs-chat-backend

# ÂÆâË£Ö‰æùËµñ
npm install

# ÁéØÂ¢ÉÈÖçÁΩÆ
cp env-template.txt .env
# ÁºñËæë .env Êñá‰ª∂

# ÂêØÂä®ÊúçÂä°
npm start
```

### 3. È™åËØÅÈÉ®ÁΩ≤

```bash
# ÂÅ•Â∫∑Ê£ÄÊü•
curl http://localhost:8888/health

# APIÊµãËØï
curl http://localhost:8888/api/user/name?username=test
```

---

## üîß ÁéØÂ¢ÉË¶ÅÊ±Ç

### Á°¨‰ª∂Ë¶ÅÊ±Ç

#### ÊúÄÂ∞èÈÖçÁΩÆ
```bash
CPU: 2Ê†∏
ÂÜÖÂ≠ò: 4GB RAM
Â≠òÂÇ®: 20GB SSD
ÁΩëÁªú: 100Mbps
```

#### Êé®ËçêÈÖçÁΩÆ  
```bash
CPU: 4Ê†∏+
ÂÜÖÂ≠ò: 8GB+ RAM
Â≠òÂÇ®: 50GB+ SSD
ÁΩëÁªú: 1Gbps+
```

#### È´òÂπ∂ÂèëÈÖçÁΩÆ
```bash
CPU: 8Ê†∏+
ÂÜÖÂ≠ò: 16GB+ RAM
Â≠òÂÇ®: 100GB+ NVMe SSD
ÁΩëÁªú: 10Gbps+
```

### ËΩØ‰ª∂Ë¶ÅÊ±Ç

```bash
Êìç‰ΩúÁ≥ªÁªü: Ubuntu 20.04+/CentOS 8+/Debian 11+
Node.js: 18.0.0+
MySQL: 8.0.0+
Nginx: 1.18+ (ÂèØÈÄâ)
Redis: 6.0+ (ÂèØÈÄâ)
```

### Á´ØÂè£Ë¶ÅÊ±Ç

| Á´ØÂè£ | ÊúçÂä° | ËØ¥Êòé |
|------|------|------|
| 8888 | HTTP API | ‰∏ªÊúçÂä°Á´ØÂè£ |
| 4443 | HTTPS API | SSLÂä†ÂØÜÁ´ØÂè£ |
| 3306 | MySQL | Êï∞ÊçÆÂ∫ìÁ´ØÂè£ |
| 443 | SSL | HTTPS‰ª£ÁêÜÁ´ØÂè£ |
| 80 | HTTP | HTTP‰ª£ÁêÜÁ´ØÂè£ |

---

## üè≠ Áîü‰∫ßÁéØÂ¢ÉÈÉ®ÁΩ≤

### 1. ‰ΩøÁî® PM2 ËøõÁ®ãÁÆ°ÁêÜ

```bash
# ÂÖ®Â±ÄÂÆâË£ÖPM2
npm install -g pm2

# ÂàõÂª∫PM2ÁîüÊÄÅÁ≥ªÁªüÊñá‰ª∂
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'nodejs-chat-backend',
    script: './src/server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 8888
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024',
    watch: false,
    ignore_watch: ['node_modules', 'logs', 'uploads'],
    restart_delay: 5000,
    max_restarts: 10,
    min_uptime: '10s'
  }]
};
EOF

# ÂêØÂä®Â∫îÁî®
pm2 start ecosystem.config.js

# ËÆæÁΩÆÂºÄÊú∫Ëá™ÂêØ
pm2 startup
pm2 save
```

### 2. NginxÂèçÂêë‰ª£ÁêÜÈÖçÁΩÆ

```nginx
# /etc/nginx/sites-available/chat-backend
upstream chat_backend {
    server localhost:8888;
    server localhost:8889 backup;  # Â§áÁî®ÊúçÂä°Âô®
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSLÈÖçÁΩÆ
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;

    # WebSocket‰ª£ÁêÜ
    location /socket.io/ {
        proxy_pass http://chat_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API‰ª£ÁêÜ
    location /api/ {
        proxy_pass http://chat_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # ÈùôÊÄÅÊñá‰ª∂
    location /uploads/ {
        alias /path/to/your/uploads/;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # ÈôêÂà∂Êñá‰ª∂‰∏ä‰º†Â§ßÂ∞è
    client_max_body_size 10M;

    # ÂÆâÂÖ®Â§¥ËÆæÁΩÆ
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
}
```

### 3. ÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆ

```bash
# .env.production
NODE_ENV=production
PORT=8888
HOST=0.0.0.0

# Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ
DB_HOST=localhost
DB_PORT=3306
DB_NAME=chat_production
DB_USER=chat_user
DB_PASSWORD=secure_password_here

# ËøûÊé•Ê±†ÈÖçÁΩÆ
DB_POOL_MAX=50
DB_POOL_MIN=10
DB_POOL_ACQUIRE=30000
DB_POOL_IDLE=30000

# JWTÈÖçÁΩÆ
JWT_SECRET=your_super_secure_jwt_secret_key_here
JWT_EXPIRES_IN=7d

# Êñá‰ª∂‰∏ä‰º†
UPLOAD_DIR=/var/www/chat/uploads/
MAX_FILE_SIZE=10485760

# Êó•ÂøóÈÖçÁΩÆ
LOG_LEVEL=info
LOG_PATH=/var/log/chat/chat.log

# WebSocket
WS_HEARTBEAT_INTERVAL=30000

# ÊÄßËÉΩÁõëÊéß
PERFORMATION_MONITOR=true
```

---

## üê≥ DockerÂÆπÂô®ÈÉ®ÁΩ≤

### 1. ÂàõÂª∫Dockerfile

```dockerfile
# Dockerfile
FROM node:18-alpine

# ÂÆâË£ÖÁ≥ªÁªü‰æùËµñ
RUN apk add --no-cache \
    dumb-init \
    python3 \
    make \
    g++ \
    && rm -rf /var/cache/apk/*

# ÂàõÂª∫Â∫îÁî®Áî®Êà∑
RUN addgroup -g 1001 -S nodejs && \
    adduser -S chat -u 1001

# ËÆæÁΩÆÂ∑•‰ΩúÁõÆÂΩï
WORKDIR /usr/src/app

# Â§çÂà∂packageÊñá‰ª∂
COPY package*.json ./

# ÂÆâË£Ö‰æùËµñ
RUN npm ci --only=production && \
    npm cache clean --force

# Â§çÂà∂Ê∫ê‰ª£Á†Å
COPY --chown=chat:nodejs . .

# ÂàõÂª∫ÂøÖË¶ÅÁöÑÁõÆÂΩï
RUN mkdir -p logs uploads && \
    chown -R chat:nodejs logs uploads

# ÂàáÊç¢Âà∞Â∫îÁî®Áî®Êà∑
USER chat

# Êö¥Èú≤Á´ØÂè£
EXPOSE 8888

# ÂÅ•Â∫∑Ê£ÄÊü•
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node -e "require('http').get('http://localhost:8888/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1))"

# ÂêØÂä®Â∫îÁî®
ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "src/server.js"]
```

### 2. Docker ComposeÈÖçÁΩÆ

```yaml
# docker-compose.yml
version: '3.8'

services:
  # Node.jsÂ∫îÁî®
  chat-backend:
    build: .
    ports:
      - "8888:8888"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=chat
      - DB_USER=chat_user
      - DB_PASSWORD=chat_password
      - JWT_SECRET=your_secret_key
    volumes:
      - ./uploads:/usr/src/app/uploads
      - ./logs:/usr/src/app/logs
    depends_on:
      - mysql
    restart: unless-stopped
    networks:
      - chat-network

  # MySQLÊï∞ÊçÆÂ∫ì
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=chat
      - MYSQL_USER=chat_user
      - MYSQL_PASSWORD=chat_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    networks:
      - chat-network
    command: --default-authentication-plugin=mysql_native_password

  # RedisÁºìÂ≠ò (ÂèØÈÄâ)
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - chat-network

  # NginxÂèçÂêë‰ª£ÁêÜ
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
      - ./uploads:/var/www/uploads
    depends_on:
      - chat-backend
    restart: unless-stopped
    networks:
      - chat-network

volumes:
  mysql_data:
  redis_data:

networks:
  chat-network:
    driver: bridge
```

### 3. ÈÉ®ÁΩ≤ÂëΩ‰ª§

```bash
# ÊûÑÂª∫Âπ∂ÂêØÂä®ÊâÄÊúâÊúçÂä°
docker-compose -f docker-compose.yml up -d

# Êü•ÁúãÊúçÂä°Áä∂ÊÄÅ
docker-compose ps

# Êü•ÁúãÊó•Âøó
docker-compose logs -f chat-backend

# Êõ¥Êñ∞ÊúçÂä°
docker-compose pull chat-backend
docker-compose up -d chat-backend

# ÂÅúÊ≠¢ÊúçÂä°
docker-compose down
```

### 4. Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñËÑöÊú¨

```sql
-- init.sql
CREATE DATABASE IF NOT EXISTS chat CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE chat;

-- Áî®Êà∑Ë°®
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    uuid VARCHAR(150) NOT NULL UNIQUE,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    nickname VARCHAR(50),
    avatar VARCHAR(350),
    email VARCHAR(100) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,
    INDEX idx_uuid (uuid),
    INDEX idx_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Ê∂àÊÅØË°®
CREATE TABLE IF NOT EXISTS messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    from_user_id INT NOT NULL,
    to_user_id INT,
    group_id INT,
    content TEXT NOT NULL,
    content_type TINYINT DEFAULT 1,
    message_type TINYINT DEFAULT 1,
    file_name VARCHAR(255),
    file_size BIGINT,
    url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,
    INDEX idx_from_user (from_user_id),
    INDEX idx_to_user (to_user_id),
    INDEX idx_group (group_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Áæ§ÁªÑË°®
CREATE TABLE IF NOT EXISTS groups (
    id INT AUTO_INCREMENT PRIMARY KEY,
    uuid VARCHAR(150) NOT NULL UNIQUE,
    user_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    notice TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL,
    INDEX idx_uuid (uuid),
    INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Áæ§ÊàêÂëòË°®
CREATE TABLE IF NOT EXISTS group_members (
    id INT AUTO_INCREMENT PRIMARY KEY,
    group_id INT NOT NULL,
    user_id INT NOT NULL,
    nickname VARCHAR(50),
    muted BOOLEAN DEFAULT FALSE,
    mute_until TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_group_user (group_id, user_id),
    INDEX idx_group (group_id),
    INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Â•ΩÂèãÂÖ≥Á≥ªË°®
CREATE TABLE IF NOT EXISTS user_friends (
    id INT AUTO_INCREMENT PRIMARY KEY,
    from_user_id INT NOT NULL,
    to_user_id INT NOT NULL,
    status ENUM('pending', 'accepted', 'blocked') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_friendship (from_user_id, to_user_id),
    INDEX idx_from_user (from_user_id),
    INDEX idx_to_user (to_user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## ‚ö° ÊÄßËÉΩ‰ºòÂåñ

### 1. Êï∞ÊçÆÂ∫ì‰ºòÂåñ

```sql
-- ‰ºòÂåñMySQLÈÖçÁΩÆ /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# Âü∫Á°ÄÈÖçÁΩÆ
max_connections = 500
max_connect_errors = 10000
connect_timeout = 10
wait_timeout = 28800

# InnoDBÈÖçÁΩÆ
innodb_buffer_pool_size = 4G
innodb_log_buffer_size = 128M
innodb_log_file_size = 512M
innodb_flush_log_at_trx_commit = 2

# Êü•ËØ¢ÁºìÂ≠ò
query_cache_size = 128M
query_cache_type = 1
query_cache_limit = 2M

# ÊÖ¢Êü•ËØ¢Êó•Âøó
slow_query_log = 1
long_query_time = 1
slow_query_log_file = /var/log/mysql/slow.log

# ‰∫åËøõÂà∂Êó•Âøó
log-bin = mysql-bin
expire_logs_days = 7
binlog_format = ROW

# Â≠óÁ¨¶ÈõÜ
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
```

### 2. Node.js‰ºòÂåñ

```bash
# ÂêØÁî®Node.js‰ºòÂåñ
export NODE_OPTIONS="--max-old-space-size=2048 --max-semi-space-size=128"

# PM2ÈõÜÁæ§Ê®°Âºè
pm2 start ecosystem.config.js --instances max

# ÂêØÁî®JSONÂéãÁº©
npm install compression
```

### 3. ÁºìÂ≠òÁ≠ñÁï•

```javascript
// RedisÁºìÂ≠òÈÖçÁΩÆ
const redis = require('redis');
const client = redis.createClient({
  host: 'localhost',
  port: 6379,
  db: 0,
  retry_strategy: (options) => {
    if (options.error && options.error.code === 'ECONNREFUSED') {
      return new Error('RedisÊúçÂä°Âô®ËøûÊé•Ë¢´ÊãíÁªù');
    }
    if (options.times_connected > 60) {
      return new Error('ÈáçËØïÊ¨°Êï∞ËøáÂ§öÔºåÂÅúÊ≠¢ÈáçËØï');
    }
    return Math.min(options.attempt * 100, 3000);
  }
});

// Áî®Êà∑ÁºìÂ≠ò
const cacheUser = async (uuid, userData) => {
  return client.setex(`user:${uuid}`, 3600, JSON.stringify(userData));
};

// Ê∂àÊÅØÁºìÂ≠ò
const cacheMessages = async (roomId, messages) => {
  return client.setex(`messages:${roomId}`, 1800, JSON.stringify(messages));
};
```

### 4. CDNÈùôÊÄÅËµÑÊ∫ê

```javascript
// ÈùôÊÄÅËµÑÊ∫êCDNÈÖçÁΩÆ
app.use('/uploads', express.static('uploads', {
  maxAge: '30d',
  etag: true,
  lastModified: true,
  setHeaders: (res, path) => {
    if (path.endsWith('.jpg') || path.endsWith('.png')) {
      res.setHeader('Cache-Control', 'public, max-age=2592000'); // 30Â§©
    }
  }
}));
```

---

## üìä ÁõëÊéßÂíåÊó•Âøó

### 1. Êó•ÂøóÁÆ°ÁêÜ

```bash
# ÂàõÂª∫Êó•ÂøóÁõÆÂΩï
sudo mkdir -p /var/log/chat
sudo chown -R nodejs:nodejs /var/log/chat

# ÈÖçÁΩÆlogrotate
cat > /etc/logrotate.d/chat-backend << EOF
/var/log/chat/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 nodejs nodejs
    postrotate
        pm2 reloadLogs
    endscript
}
EOF
```

### 2. ÁõëÊéßÈÖçÁΩÆ

```javascript
// ÊÄßËÉΩÁõëÊéß‰∏≠Èó¥‰ª∂
const performanceMonitor = (req, res, next) => {
  const startTime = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    const path = req.route ? req.route.path : req.path;
    
    // ËÆ∞ÂΩïÊÄßËÉΩÊåáÊ†á
    logger.info('API Performance', {
      method: req.method,
      path: path,
      statusCode: res.statusCode,
      duration: duration,
      userAgent: req.get('User-Agent'),
      ip: req.ip
    });
    
    // ÊÖ¢ËØ∑Ê±ÇÂëäË≠¶
    if (duration > 5000) {
      logger.warn('Slow API Request', {
        path: path,
        duration: duration,
        threshold: 5000
      });
    }
  });
  
  next();
};

app.use(performanceMonitor);
```

### 3. ÂÅ•Â∫∑Ê£ÄÊü•Á´ØÁÇπ

```javascript
// ËØ¶ÁªÜÂÅ•Â∫∑Ê£ÄÊü•
app.get('/health/detailed', authenticateToken, async (req, res) => {
  const healthCheck = {
    uptime: process.uptime(),
    timestamp: new Date().toISOString(),
    checks: {
      database: await checkDatabase(),
      redis: await checkRedis(),
      diskSpace: await checkDiskSpace(),
      memory: process.memoryUsage()
    }
  };
  
  res.json(healthCheck);
});

const checkDatabase = async () => {
  try {
    await database.authenticate();
    return { status: 'healthy', responseTime: Date.now() };
  } catch (error) {
    return { status: 'unhealthy', error: error.message };
  }
};
```

---

## üîÑ Êï∞ÊçÆÂ∫ìËøÅÁßª

### 1. ËøÅÁßªËÑöÊú¨

```bash
# ÂàõÂª∫ËøÅÁßªÁõÆÂΩï
mkdir -p migrations

# ËøÅÁßªËÑöÊú¨Á§∫‰æã
cat > migrations/001_create_tables.sql << EOF
-- ÂàõÂª∫Âü∫Êú¨Ë°®ÁªìÊûÑ
-- ËßÅ‰∏äÈù¢ÁöÑ init.sql ÂÜÖÂÆπ
EOF

cat > migrations/002_add_indexes.sql << EOF
-- Ê∑ªÂä†ÊÄßËÉΩÁ¥¢Âºï
ALTER TABLE messages ADD INDEX idx_user_timestamp (from_user_id, created_at);
ALTER TABLE group_members ADD INDEX idx_group_user (group_id, user_id);
ALTER TABLE user_friends ADD INDEX idx_status (status);
EOF
```

### 2. Êï∞ÊçÆÂ§á‰ªΩ

```bash
#!/bin/bash
# backup.sh - Êï∞ÊçÆÂ∫ìÂ§á‰ªΩËÑöÊú¨

BACKUP_DIR="/var/backups/chat"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="chat"
DB_USER="chat_user"

mkdir -p $BACKUP_DIR

# ÂÖ®ÈáèÂ§á‰ªΩ
mysqldump -u $DB_USER -p$DB_PASSWORD \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  $DB_NAME > $BACKUP_DIR/chat_backup_$DATE.sql

# ÂéãÁº©Â§á‰ªΩ
gzip $BACKUP_DIR/chat_backup_$DATE.sql

# Âà†Èô§7Â§©ÂâçÁöÑÂ§á‰ªΩ
find $BACKUP_DIR -name "chat_back_*.sql.gz" -mtime +7 -delete

echo "Â§á‰ªΩÂÆåÊàê: chat_backup_$DATE.sql.gz"
```

### 3. Êï∞ÊçÆÊÅ¢Â§ç

```bash
#!/bin/bash
# restore.sh - Êï∞ÊçÆÂ∫ìÊÅ¢Â§çËÑöÊú¨

BACKUP_FILE=$1
DB_NAME="chat"

if [ -z "$BACKUP_FILE" ]; then
    echo "Áî®Ê≥ï: $0 <backup_file.sql.gz>"
    exit 1
fi

# Ëß£ÂéãÂπ∂ÊÅ¢Â§ç
gunzip -c $BACKUP_FILE | mysql -u root -p$DB_PASSWORD $DB_NAME

echo "Êï∞ÊçÆÊÅ¢Â§çÂÆåÊàê"
```

---

## üîí SSLËØÅ‰π¶ÈÖçÁΩÆ

### 1. Let's EncryptËØÅ‰π¶

```bash
# ÂÆâË£Öcertbot
sudo apt install certbot python3-certbot-nginx

# Áî≥ËØ∑ËØÅ‰π¶
sudo certbot --nginx -d your-domain.com

# Ëá™Âä®Áª≠Êúü
sudo crontab -e
# Ê∑ªÂä†: 0 12 * * * /usr/bin/cert-renew && /sbin/service nginx reload
```

### 2. Ëá™Á≠æÂêçËØÅ‰π¶ (ÂºÄÂèëÁéØÂ¢É)

```bash
# ÁîüÊàêÁßÅÈí•
openssl genrsa -out chat-key.pem 2048

# ÁîüÊàêËØÅ‰π¶Á≠æÂêçËØ∑Ê±Ç
openssl req -new -key chat-key.pem -out chat.csr

# ÁîüÊàêËá™Á≠æÂêçËØÅ‰π¶
openssl x509 -req -in chat.csr -signkey chat-key.pem -out chat-cert.pem -days 365

# ÁßªÂä®ËØÅ‰π¶
sudo mv chat-cert.pem /etc/ssl/certs/
sudo mv chat-key.pem /etc/ssl/private/
```

### 3. Nginx SSLÈÖçÁΩÆ

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/ssl/certs/chat-cert.pem;
    ssl_certificate_file /etc/ssl/private/chat-key.pem;
    
    # ÂÆâÂÖ®ÈÖçÁΩÆ
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # ÂÖ∂‰ªñÈÖçÁΩÆ...
}
```

---

## ‚öñÔ∏è Ë¥üËΩΩÂùáË°°ÈÖçÁΩÆ

### 1. NginxË¥üËΩΩÂùáË°°

```nginx
upstream chat_backends {
    least_conn;
    server 192.170.1.10:8888 weight=3 max_fails=3 fail_timeout=30s;
    server 192.170.1.11:8888 weight=2 max_fails=3 fail_timeout=30s;
    server 192.170.1.12:8888 weight=1 max_fails=3 fail_timeout=30s;
    server 192.170.1.13:8888 backup;
}

server {
    listen 80;
    location / {
        proxy_pass http://chat_backends;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketÂçáÁ∫ß
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 2. HAProxyË¥üËΩΩÂùáË°°

```bash
# HAProxyÈÖçÁΩÆ /etc/haproxy/haproxy.cfg
global
    daemon
    
defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend chat_frontend
    bind *:80
    redirect scheme https if !{ ssl_fc }
    
    acl www hdr(host) -i your-domain.com
    use_backend chat_backend if www

frontend chat_frontend_ssl
    bind *:443 ssl crt /etc/ssl/private/chatapp.pem
    default_backend chat_backend

backend chat_backend
    balance roundrobin
    option httpchk GET /health
    
    server web1 192.170.1.10:8888 check
    server web2 192.170.1.11:8888 check
    server web3 192.170.1.12:8888 check
```

---

## üíæ Â§á‰ªΩÂíåÊÅ¢Â§ç

### 1. ÂÆåÊï¥Â§á‰ªΩÁ≠ñÁï•

```bash
#!/bin/bash
# full-backup.sh - ÂÆåÊï¥Â§á‰ªΩËÑöÊú¨

BACKUP_DIR="/var/backups/chat/full"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="chat"

mkdir -p $BACKUP_DIR

# 1. Êï∞ÊçÆÂ∫ìÂ§á‰ªΩ
mysqldump -u root -p$DB_PASSWORD \
  --single-transaction \
  --master-data=2 \
  --routines \
  --triggers \
  --all-databases > $BACKUP_DIR/all_databases_$DATE.sql

# 2. Â∫îÁî®Êñá‰ª∂Â§á‰ªΩ
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz uploads/
tar -czf $BACKUP_DIR/configs_$DATE.tar.gz src/config/ *.json

# Ë°®ÁªìÊûÑÂ§á‰ªΩ
mysqldump -u root -p$DB_PASSWORD \
  --no-data \
  --routines \
  --triggers \
  $DB_NAME > $BACKUP_DIR/schema_$DATE.sql

# 3. ÂàõÂª∫Â§á‰ªΩÁ¥¢Âºï
cat > $BACKUP_DIR/backup_$DATE.txt << EOF
Â§á‰ªΩÊó∂Èó¥: $(date)
Â§á‰ªΩÁ±ªÂûã: ÂÆåÊï¥Â§á‰ªΩ
Êï∞ÊçÆÂ∫ì: $DB_NAME
Êñá‰ª∂Â§ßÂ∞è: $(du -sh $BACKUP_DIR/)
Â§á‰ªΩÊñá‰ª∂:
- all_databases_$DATE.sql
- uploads_$DATE.tar.gz
- configs_$DATE.tar.gz
- schema_$DATE.sql
EOF

# 4. ÂéãÁº©Êï¥‰∏™Â§á‰ªΩ
tar -czf /var/backups/chat/full_backup_$DATE.tar.gz -C $BACKUP_DIR .

echo "ÂÆåÊï¥Â§á‰ªΩÂÆåÊàê: full_backup_$DATE.tar.gz"
```

### 2. Â¢ûÈáèÂ§á‰ªΩ

```bash
#!/bin/bash
# incremental-backup.sh - Â¢ûÈáèÂ§á‰ªΩËÑöÊú¨

BACKUP_DIR="/var/backups/chat/incremental"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="chat"

mkdir -p $BACKUP_DIR

# Â¢ûÈáèÂ§á‰ªΩÂè™ÂåÖÂê´Êñ∞Êï∞ÊçÆÂíåÂèòÂåñ
mysqlbinlog --start-datetime="$(date -d '1 day ago')" \
  --stop-datetime="$(date)" \
  /var/lib/mysql/mysql-bin.* > $BACKUP_DIR/binlog_$DATE.sql

echo "Â¢ûÈáèÂ§á‰ªΩÂÆåÊàê: binlog_$DATE.sql"
```

### 3. Ëá™Âä®Â§á‰ªΩ

```bash
# Ê∑ªÂä†Âà∞crontab
# ÊØèÂë®Êó•ÂáåÊô®2ÁÇπÂÆåÊï¥Â§á‰ªΩ
0 2 * * 0 /opt/chat/scripts/full-backup.sh >> /var/log/chat-backup.log 2>&1

# ÊØèÊó•ÂáåÊô®3ÁÇπÂ¢ûÈáèÂ§á‰ªΩ
0 3 * * 1-6 /opt/chat/scripts/incremental-backup.sh >> /var/log/chat-backup.log 2>&1

# ÊØèÊúà1Âè∑Ê∏ÖÁêÜ30Â§©ÂâçÁöÑÂ§á‰ªΩ
0 4 1 * * find /var/backups/chat -name "*.tar.gz" -mtime +30 -delete
```

---

## üö® ÊïÖÈöúÊéíÈô§

### 1. Â∏∏ËßÅÈóÆÈ¢òËØäÊñ≠

```bash
# Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ
systemctl status chat-backend
pm2 status
docker ps

# Ê£ÄÊü•Á´ØÂè£Âç†Áî®
netstat -tlnp | grep 8888
lsof -i :8888

# Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥
df -h
du -sh /var/log/chat/
du -sh uploads/

# Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËøûÊé•
mysql -u chat_user -p -e "SHOW PROCESSLIST;"
mysql -u chat_user -p -e "SHOW STATUS LIKE 'Connections';"

# Ê£ÄÊü•Êó•Âøó
tail -f /var/log/chat/chat.log
journalctl -u chat-backend -f
```

### 2. ÊÄßËÉΩÈóÆÈ¢òÊéíÊü•

```bash
# CPU‰ΩøÁî®Áéá
top -p $(pgrep -f "node.*server.js")

# ÂÜÖÂ≠ò‰ΩøÁî®
ps aux | grep node
free -h

# Êï∞ÊçÆÂ∫ìËøûÊé•
mysql -e "SHOW STATUS LIKE 'Threads_connected';"
mysql -e "SHOW PROCESSLIST;" | grep -v Sleep

# ÊÖ¢Êü•ËØ¢ÂàÜÊûê
mysql -e "SHOW VARIABLES LIKE 'slow_query_log%';"
tail -f /var/log/mysql/slow.log
```

### 3. WebSocketËøûÊé•ÈóÆÈ¢ò

```bash
# Ê£ÄÊü•WebSocketËøûÊé•
netstat -an | grep 8888 | grep ESTABLISHED | wc -l

# Ê£ÄÊü•Èò≤ÁÅ´Â¢ô
ufw status
iptables -L

# ÊµãËØïËøûÊé•
websocat ws://localhost:8888/socket.io/?EIO=4&transport=websocket
```

### 4. ÊïÖÈöúÊÅ¢Â§çÊ≠•È™§

```bash
# 1. ÂÅúÊ≠¢ÊúçÂä°
pm2 stop chat-backend
systemctl stop nginx

# 2. Ê£ÄÊü•ÈîôËØØÊó•Âøó
tail -100 /var/log/chat/error.log

# 3. Êï∞ÊçÆÂ∫ìÈóÆÈ¢òÊÅ¢Â§ç
mysql -u root -p -e "FLUSH TABLES;"
mysql -u root -p -e "SHOW ENGINE INNODB STATUS\G"

# 4. ÈáçÂêØÊúçÂä°
pm2 restart chat-backend
systemctl restart nginx

# 5. È™åËØÅÊúçÂä°
curl http://localhost:8888/health
```

---

## üìû ÊäÄÊúØÊîØÊåÅ

### ËÅîÁ≥ªÊñπÂºè

- üìß **ÊäÄÊúØÊîØÊåÅ**: support@example.com
- üìñ **ÊñáÊ°£Êõ¥Êñ∞**: docs@example.com  
- üêõ **BugÊä•Âëä**: bugs@example.com
- üíº **ÂïÜÂä°Âêà‰Ωú**: business@example.com

### ÊúçÂä°Á∫ßÂà´ÂçèËÆÆ

| ‰ºòÂÖàÁ∫ß | ÂìçÂ∫îÊó∂Èó¥ | Ëß£ÂÜ≥Êó∂Èó¥ |
|--------|----------|----------|
| Á¥ßÊÄ• (P1) | 15ÂàÜÈíü | 2Â∞èÊó∂ |
| È´ò (P2) | 1Â∞èÊó∂ | 4Â∞èÊó∂ |
| ‰∏≠ (P3) | 4Â∞èÊó∂ | 1Â∑•‰ΩúÊó• |
| ‰Ωé (P4) | 1Â∑•‰ΩúÊó• | 3Â∑•‰ΩúÊó• |

---

**ÊñáÊ°£ÁâàÊú¨**: v1.0.0  
**Êõ¥Êñ∞Êó•Êúü**: 2024Âπ¥12Êúà  
**ÈÄÇÁî®ÁâàÊú¨**: Node.js Chat Backend v1.0.0+  
**Áª¥Êä§Âõ¢Èòü**: DevOps Team
